<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spaced Repetition Trainer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f1115;
      --ink: #f6f3ee;
      --accent: #ff6b35;
      --accent-2: #1dd3b0;
      --paper: rgba(20, 22, 28, 0.92);
      --shadow: rgba(0, 0, 0, 0.4);
      --border: rgba(255, 255, 255, 0.12);
      --muted: rgba(246, 243, 238, 0.6);
      --input-bg: rgba(10, 11, 15, 0.6);
    }

    body.theme-light {
      --bg: #f7f4ef;
      --ink: #1b1b1b;
      --accent: #ff6b35;
      --accent-2: #1a8f78;
      --paper: rgba(255, 255, 255, 0.92);
      --shadow: rgba(40, 30, 20, 0.2);
      --border: rgba(0, 0, 0, 0.1);
      --muted: rgba(40, 35, 30, 0.6);
      --input-bg: rgba(255, 255, 255, 0.85);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      background:
        radial-gradient(circle at 20% 20%, rgba(255, 107, 53, 0.15), transparent 45%),
        radial-gradient(circle at 80% 10%, rgba(29, 211, 176, 0.18), transparent 42%),
        radial-gradient(circle at 50% 80%, rgba(255, 255, 255, 0.08), transparent 50%),
        var(--bg);
      color: var(--ink);
      min-height: 100vh;
      padding: 28px 18px 42px;
      display: grid;
      place-items: center;
    }

    .wrap {
      width: min(860px, 94vw);
      display: grid;
      gap: 16px;
    }

    body.focus-mode .bulk,
    body.focus-mode .footer {
      display: none;
    }

    body.focus-mode .wrap {
      width: min(980px, 96vw);
    }

    body.focus-mode #mainPanel {
      min-height: 70vh;
      align-content: center;
      gap: 18px;
    }

    .panel {
      background: var(--paper);
      padding: 22px;
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 50px var(--shadow);
      display: grid;
      gap: 12px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      backdrop-filter: blur(14px);
    }

    .panel.animate-in {
      animation: slideFade 0.5s ease;
    }

    .panel.correct {
      border-color: rgba(29, 211, 176, 0.7);
      box-shadow: 0 18px 40px rgba(29, 211, 176, 0.25);
    }

    .panel.wrong {
      border-color: rgba(255, 77, 109, 0.7);
      box-shadow: 0 18px 40px rgba(255, 77, 109, 0.25);
    }

    .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: "JetBrains Mono", monospace;
      font-size: 13px;
      color: var(--muted);
      gap: 10px;
      flex-wrap: wrap;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      font-family: "JetBrains Mono", monospace;
      font-size: 12px;
      color: var(--muted);
    }

    .toolbar label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toolbar select,
    .toolbar button {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      color: var(--ink);
      border: 1px solid var(--border);
      cursor: pointer;
      font-family: "JetBrains Mono", monospace;
    }

    .word {
      font-size: clamp(32px, 5vw, 48px);
      font-weight: 700;
      text-align: center;
      letter-spacing: 0.5px;
    }

    .streak {
      font-weight: 700;
      color: #ffb36b;
    }

    .direction {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255, 107, 53, 0.12);
      color: #ff8a5b;
      border: 1px solid rgba(255, 107, 53, 0.35);
    }

    .input-row {
      display: grid;
      gap: 10px;
    }

    .answer-row {
      display: grid;
      gap: 8px;
    }

    input, textarea {
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 16px;
      font-family: inherit;
      background: var(--input-bg);
      color: var(--ink);
    }

    input.input-correct {
      border-color: rgba(29, 211, 176, 0.8);
      box-shadow: 0 0 0 3px rgba(29, 211, 176, 0.2);
    }

    input.input-wrong {
      border-color: rgba(255, 77, 109, 0.8);
      box-shadow: 0 0 0 3px rgba(255, 77, 109, 0.2);
    }

    .answer-result {
      display: none;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(61, 126, 244, 0.7);
      background: rgba(61, 126, 244, 0.1);
      font-size: 16px;
      font-family: inherit;
      color: #8fb6ff;
    }

    .answer-result s {
      color: #ff6b7d;
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    button {
      padding: 12px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
    }

    .check {
      background: var(--accent-2);
      color: #0c1116;
    }

    .skip {
      background: rgba(255, 107, 53, 0.1);
      color: #ff8a5b;
      border: 1px solid rgba(255, 107, 53, 0.35);
    }

    .reveal {
      background: rgba(255, 255, 255, 0.08);
      color: var(--ink);
      border: 1px solid var(--border);
    }

    .next {
      background: rgba(29, 211, 176, 0.12);
      color: var(--accent-2);
      border: 1px solid rgba(29, 211, 176, 0.45);
    }

    .speaker {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--border);
      color: var(--ink);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .details {
      font-family: "JetBrains Mono", monospace;
      font-size: 14px;
      color: var(--muted);
      display: grid;
      gap: 6px;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
    }

    .details span {
      color: var(--ink);
      font-weight: 600;
    }

    .details.is-visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .edit-area {
      display: none;
      gap: 10px;
    }

    .edit-area.is-open {
      display: grid;
    }

    .edit-area label {
      display: grid;
      gap: 6px;
      font-size: 12px;
      font-family: "JetBrains Mono", monospace;
      color: var(--muted);
    }

    .edit-area input,
    .edit-area textarea {
      font-size: 14px;
    }

    .edit-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .list-area {
      display: none;
      gap: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      max-height: 320px;
      overflow: auto;
    }

    .list-area.is-open {
      display: grid;
    }

    .list-area table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .list-area th,
    .list-area td {
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }

    .list-area th {
      font-family: "JetBrains Mono", monospace;
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      position: sticky;
      top: 0;
      background: var(--paper);
    }

    .bulk {
      display: grid;
      gap: 10px;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      font-size: 14px;
    }

    .footer {
      font-family: "JetBrains Mono", monospace;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    @keyframes slideFade {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" id="mainPanel">
      <div class="toolbar">
        <label>
          <input type="checkbox" id="autoNextToggle" checked />
          Auto next
        </label>
        <label>
          Mode
          <select id="modeSelect">
            <option value="mixed" selected>70/30 Mix</option>
            <option value="ru-en">RU â†’ EN</option>
            <option value="en-ru">EN â†’ RU</option>
          </select>
        </label>
        <div>
          <button id="themeToggle">Toggle theme</button>
          <button id="focusToggle">Focus mode</button>
        </div>
      </div>
      <div class="meta">
        <div>Level: <span id="level">1</span></div>
        <div class="direction" id="direction">RU â†’ EN</div>
        <div class="streak" id="streak">ðŸ”¥ 0</div>
      </div>
      <div class="word" id="prompt">â€”</div>
      <div style="text-align:center;">
        <button class="speaker" id="speakBtn">Play EN</button>
      </div>
      <div class="input-row">
        <div class="answer-row">
          <input id="answer" type="text" placeholder="Type your answer" autocomplete="off" />
          <div class="answer-result" id="answerResult"></div>
        </div>
        <div class="actions">
          <button class="check" id="checkBtn">Check</button>
          <button class="reveal" id="revealBtn">Show answer</button>
          <button class="skip" id="skipBtn">Skip</button>
          <button class="next" id="nextBtn">Next</button>
        </div>
      </div>
      <div class="details" id="details">
        <div>Definition: <span id="detailDefinition">â€”</span></div>
        <div>Fact: <span id="detailFact">â€”</span></div>
      </div>
      <div class="edit-area" id="editArea">
        <label>
          English word
          <input id="editEn" type="text" placeholder="English word" />
        </label>
        <label>
          Russian translation
          <input id="editRu" type="text" placeholder="Russian translation" />
        </label>
        <label>
          Definition
          <textarea id="editDefinition" placeholder="Definition"></textarea>
        </label>
        <label>
          Example
          <textarea id="editExample" placeholder="Example"></textarea>
        </label>
        <label>
          Fact
          <textarea id="editFact" placeholder="Fact"></textarea>
        </label>
        <div class="edit-actions">
          <button class="reveal" id="listEditBtn">Full list</button>
          <button class="reveal" id="cancelEditBtn">Cancel</button>
          <button class="check" id="saveEditBtn">Save</button>
        </div>
        <div class="list-area" id="listArea">
          <div class="edit-actions" style="justify-content: space-between;">
            <div class="meta">Full list (editable)</div>
            <div style="display:flex; gap:8px;">
              <button class="reveal" id="saveListBtn">Save list</button>
              <button class="reveal" id="closeListBtn">Close list</button>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>EN</th>
                <th>RU</th>
                <th>Definition</th>
                <th>Example</th>
                <th>Fact</th>
              </tr>
            </thead>
            <tbody id="listTableBody"></tbody>
          </table>
        </div>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button class="reveal" id="editBtn">Edit word</button>
        <button class="reveal" id="deleteBtn">Delete word</button>
      </div>
    </div>

    <div class="panel bulk">
      <div class="meta">Bulk import</div>
      <textarea id="bulkInput" placeholder="archipelago ; Ð°Ñ€Ñ…Ð¸Ð¿ÐµÐ»Ð°Ð³ ; Ð³Ñ€ÑƒÐ¿Ð¿Ð° Ð¾ÑÑ‚Ñ€Ð¾Ð²Ð¾Ð²... ; â€œExample.â€ ; Ñ„Ð°ÐºÑ‚"></textarea>
      <button class="check" id="bulkAddBtn">Add words</button>
      <div class="meta" id="bulkStatus"></div>
    </div>

    <div class="footer">Spaced repetition with weighted random and streaks. Data stored in SQLite.</div>
  </div>

  <script>
    const levelIntervals = {
      1: 10 * 60 * 1000,
      2: 60 * 60 * 1000,
      3: 24 * 60 * 60 * 1000,
      4: 3 * 24 * 60 * 60 * 1000,
      5: 7 * 24 * 60 * 60 * 1000
    };

    const state = {
      words: [],
      current: null,
      direction: "RU_TO_EN"
    };

    const levelEl = document.getElementById("level");
    const directionEl = document.getElementById("direction");
    const streakEl = document.getElementById("streak");
    const promptEl = document.getElementById("prompt");
    const answerEl = document.getElementById("answer");
    const answerResult = document.getElementById("answerResult");
    const speakBtn = document.getElementById("speakBtn");
    const nextBtn = document.getElementById("nextBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const editBtn = document.getElementById("editBtn");
    const autoNextToggle = document.getElementById("autoNextToggle");
    const themeToggle = document.getElementById("themeToggle");
    const modeSelect = document.getElementById("modeSelect");
    const focusToggle = document.getElementById("focusToggle");
    const mainPanel = document.getElementById("mainPanel");
    const detailDefinition = document.getElementById("detailDefinition");
    const detailFact = document.getElementById("detailFact");
    const detailsEl = document.getElementById("details");
    const checkBtn = document.getElementById("checkBtn");
    const revealBtn = document.getElementById("revealBtn");
    const skipBtn = document.getElementById("skipBtn");
    const bulkInput = document.getElementById("bulkInput");
    const bulkAddBtn = document.getElementById("bulkAddBtn");
    const bulkStatus = document.getElementById("bulkStatus");
    const saveEditBtn = document.getElementById("saveEditBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const editArea = document.getElementById("editArea");
    const editEn = document.getElementById("editEn");
    const editRu = document.getElementById("editRu");
    const editDefinition = document.getElementById("editDefinition");
    const editExample = document.getElementById("editExample");
    const editFact = document.getElementById("editFact");
    const listEditBtn = document.getElementById("listEditBtn");
    const listArea = document.getElementById("listArea");
    const listTableBody = document.getElementById("listTableBody");
    const closeListBtn = document.getElementById("closeListBtn");

    let isLocked = false;
    let pendingNext = false;
    let autoNext = true;
    let mode = "mixed";

    function calculateNextReview(level, isWrong = false) {
      if (isWrong) return Date.now() + 5 * 60 * 1000;
      const interval = levelIntervals[level] || levelIntervals[1];
      return Date.now() + interval;
    }

    function chooseDirection() {
      if (mode === "ru-en") return "RU_TO_EN";
      if (mode === "en-ru") return "EN_TO_RU";
      return Math.random() < 0.7 ? "RU_TO_EN" : "EN_TO_RU";
    }

    function getDueWords() {
      const now = Date.now();
      return state.words.filter((word) => word.next_review <= now);
    }

    function getWeightedRandomWord(words) {
      const weights = words.map((word) => {
        const levelWeight = 6 - word.level;
        const lowLevelBoost = word.level <= 2 ? 2 : 1;
        return levelWeight * lowLevelBoost;
      });
      const total = weights.reduce((sum, w) => sum + w, 0);
      let roll = Math.random() * total;
      for (let i = 0; i < words.length; i += 1) {
        roll -= weights[i];
        if (roll <= 0) return words[i];
      }
      return words[0];
    }

    function updateWordProgress(word, isCorrect) {
      if (isCorrect) {
        word.level = Math.min(5, word.level + 1);
        word.streak += 1;
      } else {
        word.level = Math.max(1, word.level - 1);
        word.streak = 0;
      }
      word.next_review = calculateNextReview(word.level, !isCorrect);
    }

    async function syncWord(word) {
      await fetch(`/api/words/${word.id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          level: word.level,
          next_review: word.next_review,
          streak: word.streak
        })
      });
    }

    function updateUI() {
      if (!state.current) {
        promptEl.textContent = "No due words";
        levelEl.textContent = "â€”";
        directionEl.textContent = "â€”";
        answerEl.value = "";
        answerEl.classList.remove("input-correct", "input-wrong");
        answerEl.style.display = "block";
        answerResult.style.display = "none";
        mainPanel.classList.remove("correct", "wrong");
        pendingNext = false;
        nextBtn.disabled = true;
        mainPanel.classList.remove("animate-in");
        detailDefinition.textContent = "â€”";
        detailFact.textContent = "â€”";
        detailsEl.classList.remove("is-visible");
        return;
      }
      levelEl.textContent = state.current.level;
      streakEl.textContent = `ðŸ”¥ ${state.current.streak}`;
      directionEl.textContent = state.direction === "RU_TO_EN" ? "RU â†’ EN" : "EN â†’ RU";
      promptEl.textContent = state.direction === "RU_TO_EN" ? state.current.ru : state.current.en;
      detailDefinition.textContent = state.current.definition || "â€”";
      detailFact.textContent = state.current.fact || "â€”";
      detailsEl.classList.remove("is-visible");
      answerEl.value = "";
      answerEl.classList.remove("input-correct", "input-wrong");
      answerEl.style.display = "block";
      answerResult.style.display = "none";
      mainPanel.classList.remove("correct", "wrong");
      mainPanel.classList.remove("animate-in");
      void mainPanel.offsetWidth;
      mainPanel.classList.add("animate-in");
      isLocked = false;
      checkBtn.disabled = false;
      skipBtn.disabled = false;
      revealBtn.disabled = false;
      nextBtn.disabled = true;
      pendingNext = false;
      answerEl.focus();
    }

    function pickNextWord() {
      const due = getDueWords();
      if (!due.length) {
        state.current = null;
        updateUI();
        return;
      }
      state.current = getWeightedRandomWord(due);
      state.direction = chooseDirection();
      updateUI();
    }

    function normalize(text) {
      return text.trim().toLowerCase();
    }

    function setLocked() {
      isLocked = true;
      checkBtn.disabled = true;
      skipBtn.disabled = true;
      revealBtn.disabled = true;
    }

    function scheduleNext(delayMs) {
      if (autoNext) {
        setTimeout(() => {
          pickNextWord();
        }, delayMs);
      } else {
        pendingNext = true;
        nextBtn.disabled = false;
      }
    }

    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function parseBulk(text) {
      const lines = text
        .split(/\r?\n/)
        .map((line) => line.trim())
        .filter(Boolean);

      const result = [];
      for (const line of lines) {
        const parts = line.split(";").map((part) => part.trim()).filter(Boolean);
        if (parts.length < 2) continue;
        const [en, ru, definition, example, ...rest] = parts;
        const fact = rest.length ? rest.join("; ") : "";
        result.push({ en, ru, definition, example, fact });
      }
      return result;
    }

    async function handleCheck() {
      if (!state.current) return;
      if (isLocked) return;
      const userAnswerRaw = answerEl.value.trim();
      const userAnswer = normalize(userAnswerRaw);
      const correctAnswerRaw = state.direction === "RU_TO_EN" ? state.current.en : state.current.ru;
      const correctAnswer = normalize(correctAnswerRaw);

      const isCorrect = userAnswer === correctAnswer;
      if (isCorrect) {
        mainPanel.classList.add("correct");
        mainPanel.classList.remove("wrong");
        answerEl.classList.add("input-correct");
        answerEl.classList.remove("input-wrong");
      } else {
        mainPanel.classList.add("wrong");
        mainPanel.classList.remove("correct");
        answerEl.classList.add("input-wrong");
        answerEl.classList.remove("input-correct");
      }

      if (!isCorrect) {
        const safeUser = userAnswerRaw || "â€”";
        const example = state.current.example ? `<div style="margin-top:6px;">${escapeHtml(state.current.example)}</div>` : "";
        answerResult.innerHTML = `<s>${escapeHtml(safeUser)}</s> â†’ ${escapeHtml(correctAnswerRaw)}${example}`;
        answerResult.style.display = "block";
      } else if (state.current.example) {
        answerResult.innerHTML = `<div>${escapeHtml(state.current.example)}</div>`;
        answerResult.style.display = "block";
      }

      detailsEl.classList.add("is-visible");

      updateWordProgress(state.current, isCorrect);
      await syncWord(state.current);
      setLocked();
      scheduleNext(isCorrect ? 1400 : 1800);
    }

    function handleSkip() {
      if (!state.current) return;
      if (isLocked) return;
      pickNextWord();
    }

    async function handleReveal() {
      if (!state.current) return;
      if (isLocked) return;
      const correctAnswerRaw = state.direction === "RU_TO_EN" ? state.current.en : state.current.ru;
      const safeUser = answerEl.value.trim() || "â€”";
      const example = state.current.example ? `<div style="margin-top:6px;">${escapeHtml(state.current.example)}</div>` : "";
      answerResult.innerHTML = `<s>${escapeHtml(safeUser)}</s> â†’ ${escapeHtml(correctAnswerRaw)}${example}`;
      answerResult.style.display = "block";
      mainPanel.classList.add("wrong");
      mainPanel.classList.remove("correct");
      detailsEl.classList.add("is-visible");
      updateWordProgress(state.current, false);
      await syncWord(state.current);
      setLocked();
      scheduleNext(1800);
    }

    function handleNext() {
      if (!pendingNext) return;
      pickNextWord();
    }

    function speakEnglish() {
      if (!state.current) return;
      if (!("speechSynthesis" in window)) return;
      const utterance = new SpeechSynthesisUtterance(state.current.en);
      utterance.lang = "en-US";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }

    async function handleDelete() {
      if (!state.current) return;
      await fetch(`/api/words/${state.current.id}`, { method: "DELETE" });
      await loadWords();
      pickNextWord();
    }

    function openInlineEdit() {
      if (!state.current) return;
      editEn.value = state.current.en || "";
      editRu.value = state.current.ru || "";
      editDefinition.value = state.current.definition || "";
      editExample.value = state.current.example || "";
      editFact.value = state.current.fact || "";
      editArea.classList.add("is-open");
    }

    function closeInlineEdit() {
      editArea.classList.remove("is-open");
    }

    async function saveInlineEdit() {
      if (!state.current) return;
      const payload = {
        en: editEn.value.trim(),
        ru: editRu.value.trim(),
        definition: editDefinition.value.trim(),
        example: editExample.value.trim(),
        fact: editFact.value.trim()
      };
      await fetch(`/api/words/${state.current.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      await loadWords();
      pickNextWord();
      closeInlineEdit();
    }

    function openFullList() {
      listTableBody.innerHTML = "";
      state.words.forEach((word) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${escapeHtml(word.en || "")}</td>
          <td>${escapeHtml(word.ru || "")}</td>
          <td>${escapeHtml(word.definition || "")}</td>
          <td>${escapeHtml(word.example || "")}</td>
          <td>${escapeHtml(word.fact || "")}</td>
        `;
        listTableBody.appendChild(row);
      });
      listArea.classList.add("is-open");
    }

    async function loadWords() {
      const res = await fetch("/api/words");
      const data = await res.json();
      state.words = data.words || [];
    }

    async function handleBulkAdd() {
      const raw = bulkInput.value.trim();
      if (!raw) {
        bulkStatus.textContent = "Paste your list first.";
        return;
      }
      const parsed = parseBulk(raw);
      if (!parsed.length) {
        bulkStatus.textContent = "No valid lines found. Use: word ; translation ; definition ; example ; fact";
        return;
      }
      bulkStatus.textContent = `Adding ${parsed.length} words...`;
      const res = await fetch("/api/words", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ words: parsed })
      });
      if (!res.ok) {
        const errorText = await res.text();
        bulkStatus.textContent = `Failed to add words: ${errorText}`;
        return;
      }
      const data = await res.json();
      bulkStatus.textContent = `Added ${data.inserted} words.`;
      bulkInput.value = "";
      await loadWords();
      pickNextWord();
    }

    function applyTheme(theme) {
      document.body.classList.toggle("theme-light", theme === "light");
      localStorage.setItem("theme", theme);
    }

    checkBtn.addEventListener("click", handleCheck);
    revealBtn.addEventListener("click", handleReveal);
    skipBtn.addEventListener("click", handleSkip);
    nextBtn.addEventListener("click", handleNext);
    bulkAddBtn.addEventListener("click", handleBulkAdd);
    speakBtn.addEventListener("click", speakEnglish);
    deleteBtn.addEventListener("click", handleDelete);
    editBtn.addEventListener("click", openInlineEdit);
    cancelEditBtn.addEventListener("click", closeInlineEdit);
    saveEditBtn.addEventListener("click", saveInlineEdit);
    listEditBtn.addEventListener("click", openFullList);
    closeListBtn.addEventListener("click", () => {
      listArea.classList.remove("is-open");
    });
    focusToggle.addEventListener("click", () => {
      document.body.classList.toggle("focus-mode");
    });
    autoNextToggle.addEventListener("change", () => {
      autoNext = autoNextToggle.checked;
      if (autoNext && pendingNext) {
        pickNextWord();
      }
    });
    themeToggle.addEventListener("click", () => {
      const current = document.body.classList.contains("theme-light") ? "light" : "dark";
      applyTheme(current === "light" ? "dark" : "light");
    });
    modeSelect.addEventListener("change", () => {
      mode = modeSelect.value;
      localStorage.setItem("mode", mode);
      pickNextWord();
    });
    answerEl.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        if (pendingNext && !autoNext) {
          handleNext();
        } else {
          handleCheck();
        }
      }
    });

    const savedTheme = localStorage.getItem("theme") || "dark";
    applyTheme(savedTheme);
    mode = localStorage.getItem("mode") || "mixed";
    modeSelect.value = mode;

    loadWords().then(pickNextWord);
  </script>
</body>
</html>
