<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spaced Repetition Trainer</title>
  <style>
    :root {
      --bg: #f4f0e6;
      --ink: #1b1b1b;
      --accent: #c04b3c;
      --accent-2: #2f5d50;
      --paper: #fffaf3;
      --shadow: rgba(20, 20, 20, 0.18);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Georgia", serif;
      background: radial-gradient(circle at top left, #faf6ef, #efe4d0 55%, #e2d3bb 100%);
      color: var(--ink);
      min-height: 100vh;
      padding: 32px 20px 48px;
      display: grid;
      place-items: center;
    }

    .wrap {
      width: min(720px, 94vw);
      display: grid;
      gap: 16px;
    }

    .panel {
      background: var(--paper);
      padding: 22px;
      border-radius: 18px;
      box-shadow: 0 14px 30px var(--shadow);
      display: grid;
      gap: 12px;
    }

    .word {
      font-size: clamp(32px, 5vw, 48px);
      font-weight: 700;
      text-align: center;
    }

    .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: "Courier New", monospace;
      font-size: 13px;
      color: #5d5243;
      gap: 10px;
      flex-wrap: wrap;
    }

    .streak {
      font-weight: 700;
      color: #d25422;
    }

    .direction {
      padding: 4px 8px;
      border-radius: 999px;
      background: #fff2e9;
      color: #c04b3c;
      border: 1px solid #f2c7a8;
    }

    .input-row {
      display: grid;
      gap: 10px;
    }

    input {
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #d6c9b7;
      font-size: 16px;
      font-family: inherit;
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    button {
      padding: 12px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
    }

    .check {
      background: var(--accent-2);
      color: #fff;
    }

    .skip {
      background: #fff2e9;
      color: var(--accent);
      border: 1px solid #f2c7a8;
    }

    .status {
      font-family: "Courier New", monospace;
      font-size: 13px;
      color: #5d5243;
      min-height: 18px;
    }

    .footer {
      font-family: "Courier New", monospace;
      font-size: 12px;
      color: #6a5e4f;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="meta">
        <div>Level: <span id="level">1</span></div>
        <div class="direction" id="direction">RU â†’ EN</div>
        <div class="streak" id="streak">ðŸ”¥ 0</div>
      </div>
      <div class="word" id="prompt">â€”</div>
      <div class="input-row">
        <input id="answer" type="text" placeholder="Type your answer" autocomplete="off" />
        <div class="actions">
          <button class="check" id="checkBtn">Check</button>
          <button class="skip" id="skipBtn">Skip</button>
        </div>
      </div>
      <div class="status" id="status"></div>
    </div>
    <div class="footer">Spaced repetition with weighted random and streaks. Data stored in SQLite.</div>
  </div>

  <script>
    const state = {
      words: [],
      current: null,
      direction: "RU_TO_EN"
    };

    const levelIntervals = {
      1: 10 * 60 * 1000,
      2: 60 * 60 * 1000,
      3: 24 * 60 * 60 * 1000,
      4: 3 * 24 * 60 * 60 * 1000,
      5: 7 * 24 * 60 * 60 * 1000
    };

    const levelEl = document.getElementById("level");
    const directionEl = document.getElementById("direction");
    const streakEl = document.getElementById("streak");
    const promptEl = document.getElementById("prompt");
    const answerEl = document.getElementById("answer");
    const statusEl = document.getElementById("status");
    const checkBtn = document.getElementById("checkBtn");
    const skipBtn = document.getElementById("skipBtn");

    function calculateNextReview(level, isWrong = false) {
      if (isWrong) return Date.now() + 5 * 60 * 1000;
      const interval = levelIntervals[level] || levelIntervals[1];
      return Date.now() + interval;
    }

    function chooseDirection() {
      return Math.random() < 0.7 ? "RU_TO_EN" : "EN_TO_RU";
    }

    function getDueWords() {
      const now = Date.now();
      return state.words.filter((word) => word.next_review <= now);
    }

    function getWeightedRandomWord(words) {
      const weights = words.map((word) => {
        const levelWeight = 6 - word.level;
        const lowLevelBoost = word.level <= 2 ? 2 : 1;
        return levelWeight * lowLevelBoost;
      });
      const total = weights.reduce((sum, w) => sum + w, 0);
      let roll = Math.random() * total;
      for (let i = 0; i < words.length; i += 1) {
        roll -= weights[i];
        if (roll <= 0) return words[i];
      }
      return words[0];
    }

    function updateWordProgress(word, isCorrect) {
      if (isCorrect) {
        word.level = Math.min(5, word.level + 1);
        word.streak += 1;
      } else {
        word.level = Math.max(1, word.level - 1);
        word.streak = 0;
      }
      word.next_review = calculateNextReview(word.level, !isCorrect);
    }

    async function syncWord(word) {
      await fetch(`/api/words/${word.id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          level: word.level,
          next_review: word.next_review,
          streak: word.streak
        })
      });
    }

    function updateUI() {
      if (!state.current) {
        promptEl.textContent = "No due words";
        levelEl.textContent = "â€”";
        directionEl.textContent = "â€”";
        statusEl.textContent = "Come back later when words are due.";
        answerEl.value = "";
        return;
      }
      levelEl.textContent = state.current.level;
      streakEl.textContent = `ðŸ”¥ ${state.current.streak}`;
      directionEl.textContent = state.direction === "RU_TO_EN" ? "RU â†’ EN" : "EN â†’ RU";
      promptEl.textContent = state.direction === "RU_TO_EN" ? state.current.ru : state.current.en;
      answerEl.value = "";
      statusEl.textContent = "";
      answerEl.focus();
    }

    function pickNextWord() {
      const due = getDueWords();
      if (!due.length) {
        state.current = null;
        updateUI();
        return;
      }
      state.current = getWeightedRandomWord(due);
      state.direction = chooseDirection();
      updateUI();
    }

    function normalize(text) {
      return text.trim().toLowerCase();
    }

    async function handleCheck() {
      if (!state.current) return;
      const userAnswer = normalize(answerEl.value);
      const correctAnswer = normalize(
        state.direction === "RU_TO_EN" ? state.current.en : state.current.ru
      );

      const isCorrect = userAnswer === correctAnswer;
      if (isCorrect) {
        statusEl.textContent = "Correct!";
      } else {
        statusEl.textContent = `Wrong. Correct answer: ${correctAnswer}`;
      }

      updateWordProgress(state.current, isCorrect);
      await syncWord(state.current);
      pickNextWord();
    }

    function handleSkip() {
      if (!state.current) return;
      statusEl.textContent = "Skipped.";
      pickNextWord();
    }

    async function loadWords() {
      const res = await fetch("/api/words");
      const data = await res.json();
      state.words = data.words || [];
    }

    checkBtn.addEventListener("click", handleCheck);
    skipBtn.addEventListener("click", handleSkip);
    answerEl.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        handleCheck();
      }
    });

    loadWords().then(pickNextWord);
  </script>
</body>
</html>
